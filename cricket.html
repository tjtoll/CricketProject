<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cricket!</title>
</head>
<body>
<style>

#yearFilterSelection{
    position:absolute;
    bottom:70px;
    left:150px;}

#batMeasureFilterSelection{
    position:absolute;
    bottom:70px;
    left:210px;}

#bowlMeasureFilterSelection{
    position:absolute;
    bottom:70px;
    left:320px;}

#yearFilterTitle{
    position:absolute;
    bottom:90px;
    left:150px;
    font-family: sans-serif;
    font-size: 12px;}

#batMeasureFilterTitle{
    position:absolute;
    bottom:90px;
    left:210px;
    font-family: sans-serif;
    font-size: 12px;}

#bowlMeasureFilterTitle{
    position:absolute;
    bottom:90px;
    left:320px;
    font-family: sans-serif;
    font-size: 12px;}

#teamFilterSelection{
    position:absolute;
    top:45px;
    left:225px;
    font-family: sans-serif;
    font-size: 18px;
}

#teamFilterTitle{
    position:absolute;
    top:45px;
    left:100px;
    font-family: sans-serif;
    font-size: 18px;}

p {
    text-align:center;
    font-family: sans-serif;
    font-size: 18px;
    border-bottom: 3px double;
}
#content img {
    position: absolute;
    top: 0px;
    right: 0px;
}


#area5{
    position:absolute;
    bottom:30px;
    left:5px;}



#scatterMeasureFilterSelection{
    position:absolute;
    top:375px;
    left:1070px;}

#scatterPlot{
    position:absolute;
    top:360px;
    left:990px;}

#scatterPlotTitle{
    position:absolute;
    top:350px;
    left:1025px;
    font-family: sans-serif;
    font-size: 18px;}

#sparkLinesTitle{
    position:absolute;
    top:350px;
    left:550px;
    font-family: sans-serif;
    font-size: 18px;}

#leftSpark1{
    position:absolute;
    width: 100px;
    height: 75px;
    top:380px;
    left:850px;}

#leftSpark2{
    position:absolute;
    width: 100px;
    height: 75px;
    top:450px;
    left:850px;}

#leftSpark3{
    position:absolute;
    width: 100px;
    height: 75px;
    top:520px;
    left:850px;}

#leftSpark4{
    position:absolute;
    width: 100px;
    height: 75px;
    top:590px;
    left:850px;}
.axis path,
.axis line {
    fill: none;
    stroke: black;
    shape-rendering: crispEdges;
}



#middleSpark1{
    position:absolute;
    width: 100px;
    height: 75px;
    top:380px;
    left:700px;}

#middleSpark2{
    position:absolute;
    width: 100px;
    height: 75px;
    top:450px;
    left:700px;}

#middleSpark3{
    position:absolute;
    width: 100px;
    height: 75px;
    top:520px;
    left:700px;}

#middleSpark4{
    position:absolute;
    width: 100px;
    height: 75px;
    top:590px;
    left:700px;}


#rightSpark1{
    position:absolute;
    width: 100px;
    height: 75px;
    top:380px;
    left:550px;}

#rightSpark2{
    position:absolute;
    width: 100px;
    height: 75px;
    top:450px;
    left:550px;}

#rightSpark3{
    position:absolute;
    width: 100px;
    height: 75px;
    top:520px;
    left:550px;}

#rightSpark4{
    position:absolute;
    width: 100px;
    height: 75px;
    top:590px;
    left:550px;}

</style>

<div id="content">
    <img src="ipl.png" class="ribbon" width="75"/>
    <div><p> Project 2 for H517 Visualization Design, Analysis,
        & Evaluation</p></div>
</div>

<div class="container" id="field">
</div>

<div class="container" id="scatterPlot">
</div>

<div class="container" id="batArea">
</div>
<div class="container" id="area5">
</div>

<div id="yearFilterTitle">
    <div>Season</div>
</div>

<div id="batMeasureFilterTitle">
    <div>Batting Measure</div>
</div>

<div class="container" id="leftSpark1"></div>
<div class="container" id="leftSpark2"></div>
<div class="container" id="leftSpark3"></div>
<div class="container" id="leftSpark4"></div>
<div class="container" id="middleSpark1"></div>
<div class="container" id="middleSpark2"></div>
<div class="container" id="middleSpark3"></div>
<div class="container" id="middleSpark4"></div>
<div class="container" id="rightSpark1"></div>
<div class="container" id="rightSpark2"></div>
<div class="container" id="rightSpark3"></div>
<div class="container" id="rightSpark4"></div>


<div id="scatterPlotTitle">
    <div>Matches Won vs. Selected Measures by Season</div>
</div>

<div id="sparkLinesTitle">
    <div>Measure Spark Lines by Season</div>
</div>

<div id="bowlMeasureFilterTitle">
    <div>Bowling Measure</div>
</div>

<div id="teamFilterTitle">
    <div>Select a team:</div>
</div>
<div id="about">
    <a href="about.html">About</a>
</div>

<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="//code.jquery.com/jquery-1.10.2.js"></script>

<select id="yearFilterSelection"></select>
<select id="teamFilterSelection"></select>
<select id="bowlMeasureFilterSelection"></select>
<select id="batMeasureFilterSelection"></select>
<select id="scatterMeasureFilterSelection"></select>


<script type="text/javascript">
    var d = document.getElementById('about');
    d.style.position = "absolute";
    d.style.right = 100+'px';
    d.style.top = 15+'px';


    var fieldSVGHeight = 600;
    var scoreAreaOpacity = .60;
    var fieldSVGWidth = 500;
    var outfieldShapeFactor = 1.09;
    var infieldShapeFactor = 1.04;
    var centerOfFieldFactor = 2;
    var fieldWhiteBorderWidths = 4;
    var pitchWidth = (fieldSVGWidth/12);
    var pitchHeight = (fieldSVGHeight/5);
    var closeInfieldOffset = 35;
    var closeInfieldLineLength = 75;
    var selectedOption = 2014;
    var cricketField = d3.select("#field").append("svg")
        .attr("width", fieldSVGWidth)
        .attr("height", fieldSVGHeight)
        .call(d3.behavior.zoom().on("zoom", function () {
            cricketField.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
        }))
        .append('g');
    var svgMapLegend = d3.select("#area5").append("svg")
        .attr("width", 150)
        .attr("height", 125)
        .append('g');

    function drawMapLegend() {
        d3.csv("legend.csv", function (mapLegend) {

            svgMapLegend.selectAll("legends")
                .data(mapLegend)
                .enter()
                .append("circle")
                .attr("cy", function (d, i) {
                    return (d.a * 25)
                        ;
                })
                .attr("cx", 15)
                .attr("r", 6)
                .attr("fill", function (d, i) {
                    if (d.a == 1) {
                        return "#0571b0"
                    }
                    if (d.a == 2) {
                        return "#92c5de"
                    }
                    if (d.a == 4) {
                        return "#ca0020"
                    }
                    if (d.a == 3) {
                        return "#f4a582"
                    }
                    ;
                });

            svgMapLegend.selectAll("legends")
                .data(mapLegend)
                .enter()
                .append("text")
                .attr("y", function (d, i) {
                    return (d.a * 25) + 5
                        ;
                })
                .attr("x", 25)
                .style("font-size", "12px")
                .style("fill", "black")
                .style("font-family", "sans-serif")
                .text(function (d) {
                    return d.b
                });


        });
    }




    d3.csv("cricketPivot.csv", function(cricketdummy){

            d3.select("#batMeasureFilterSelection")
                .selectAll('myOptions')
                .data(d3.map(cricketdummy, function(d){ if (d.MeasureType  == "Batting" ) { return d.MeasureName }
                else { return "Innings" }
                    ; }).keys())
                .enter()
                .append('option')
                .text(function(d){return d;})
                .attr("value",function(d){return d;});

            d3.select('#batMeasureFilterSelection').property('value', 'StrikeRate');

            d3.select("#bowlMeasureFilterSelection")
                .selectAll('myOptions')
                .data(d3.map(cricketdummy, function(d){ if (d.MeasureType  == "Bowling" ) { return d.MeasureName }
                else { return "BowlingEconomy" }
                    ; }).keys())
                .enter()
                .append('option')
                .text(function(d){return d;})
                .attr("value",function(d){return d;});

        d3.select("#scatterMeasureFilterSelection")
            .selectAll('myOptions')
            .data(d3.map(cricketdummy, function(d){ return d.MeasureName }).keys())
            .enter()
            .append('option')
            .text(function(d){return d;})
            .attr("value",function(d){return d;});
        d3.select('#scatterMeasureFilterSelection').property('value', 'BowlingEconomy');


        // populating the years in the filter drop down
        d3.select("#yearFilterSelection")
            .selectAll('myOptions')
            .data(d3.map(cricketdummy, function(d){return d.Year;}).keys())
            .enter()
            .append('option')
            .text(function(d){return d;})
            .attr("value",function(d){return d;});
        // populating the teams in the filter drop down
        d3.select("#teamFilterSelection")
            .selectAll('myOptions')
            .data(d3.map(cricketdummy, function(d){return d.Team;}).keys())
            .enter()
            .append('option')
            .text(function(d){return d;})
            .attr("value",function(d){return d;});
        // changing the area scores based on the year selection

        function aggregateData(){
            //#batMeasureFilterSelection
           var dataAggregation = d3.nest()
                .key(function(d) { return d.Year;})
                .rollup(function(d) { return {
                    BatScoreAggAvg: d3.mean(d, function(d) { if (d.MeasureName  == d3.select("#batMeasureFilterSelection").property("value")) { return d.MeasureValue }
                    else { return null }
                        ; }),
                    BatScoreAggSd: d3.deviation(d, function(d) { if (d.MeasureName  == d3.select("#batMeasureFilterSelection").property("value")) { return d.MeasureValue }
                    else { return null }
                        ; }),
                    BatScore: d3.sum(d, function(d) { if (d.Team  == d3.select("#teamFilterSelection").property("value") && d.MeasureName  == d3.select("#batMeasureFilterSelection").property("value")) { return d.MeasureValue }
                    else { return 0 }
                        ; }),
                    BowlScoreAggAvg: d3.mean(d, function(d) { if (d.MeasureName  == d3.select("#bowlMeasureFilterSelection").property("value")) { return d.MeasureValue }
                    else { return null }
                        ; }),
                    BowlScoreAggSd: d3.deviation(d, function(d) { if (d.MeasureName  == d3.select("#bowlMeasureFilterSelection").property("value")) { return d.MeasureValue }
                    else { return null }
                        ; }),
                    BowlScore: d3.sum(d, function(d) { if (d.Team  == d3.select("#teamFilterSelection").property("value") && d.MeasureName  == d3.select("#bowlMeasureFilterSelection").property("value")) { return d.MeasureValue }
                    else { return 0 }
                        ; }),
                    FieldingScoreAggAvg: d3.mean(d, function(d) { return d.MeasureValue; }),
                    FieldingScoreAggSd: d3.deviation(d, function(d) { return d.MeasureValue; }),
                    FieldingScore: d3.sum(d, function(d) { if (d.Team  == d3.select("#teamFilterSelection").property("value") ) { return d.MeasureValue }
                    else { return 0 }
                        ; })

                }; }).entries(filteredToYear);
            return dataAggregation
        }

        function aggregateDataScatter(){
            //filteredToTeam = cricketdummy.filter(function(d){return d.Team == d3.select("#teamFilterSelection").property("value");});
            var dataAggregation = d3.nest()
                .key(function(d) { return d.Year;})
                .rollup(function(d) { return {
                    MatchesWon: d3.sum(d, function(d) { if (d.MeasureName  == "MatchesWon" && d.Team  == d3.select("#teamFilterSelection").property("value")) { return d.MeasureValue }
                    else { return null }
                        ; }),
                    ScatterMeasure: d3.sum(d, function(d) { if (d.MeasureName  == d3.select("#scatterMeasureFilterSelection").property("value") && d.Team  == d3.select("#teamFilterSelection").property("value")) { return d.MeasureValue }
                    else { return null }
                        ; }),

                    ScatterMeasureAggAvg: d3.mean(d, function(d) { if (d.MeasureName  == d3.select("#scatterMeasureFilterSelection").property("value")) { return d.MeasureValue }
                    else { return null }
                        ; }),
                    ScatterMeasureAggSd: d3.deviation(d, function(d) { if (d.MeasureName  == d3.select("#scatterMeasureFilterSelection").property("value")) { return d.MeasureValue }
                    else { return null }
                        ; })

                }; }).entries(cricketdummy);
            var filtereddata = dataAggregation.filter(function(d){return d.values.ScatterMeasure > 0;});
            return filtereddata
        }
        function getBatScoreColor(batScore)
        {
            var batScoreColor;
            // color is based on standard deviation
            if (batScore[0].values.BatScore > batScore[0].values.BatScoreAggSd + batScore[0].values.BatScoreAggAvg) {
                batScoreColor = "#0571b0";
            }
            else if (batScore[0].values.BatScore >= batScore[0].values.BatScoreAggAvg) {
                batScoreColor = "#92c5de";
            }
            else if (batScore[0].values.BatScore < batScore[0].values.BatScoreAggAvg-batScore[0].values.BatScoreAggSd) {
                batScoreColor = "#ca0020";
            }
            else if (batScore[0].values.BatScore <= batScore[0].values.BatScoreAggAvg) {
                batScoreColor = "#f4a582";
            }
            return batScoreColor
        }
        function getBowlScoreColor(batScore)
        {
            var BowlScoreColor;
            // color is based on standard deviation
            if (batScore[0].values.BowlScore > batScore[0].values.BowlScoreAggSd + batScore[0].values.BowlScoreAggAvg) {
                BowlScoreColor = "#0571b0";
            }
            else if (batScore[0].values.BowlScore >= batScore[0].values.BowlScoreAggAvg) {
                BowlScoreColor = "#92c5de";
            }
            else if (batScore[0].values.BowlScore <  batScore[0].values.BowlScoreAggAvg-batScore[0].values.BowlScoreAggSd) {
                BowlScoreColor = "#ca0020";
            }
            else if (batScore[0].values.BowlScore <= batScore[0].values.BowlScoreAggAvg) {
                BowlScoreColor = "#f4a582";
            }
            return BowlScoreColor
        }
        function getFieldingScoreColor(batScore)
        {
            var FieldingScoreColor;
            // color is based on standard deviation
            if (batScore[0].values.FieldingScore > batScore[0].values.FieldingScoreAggSd + batScore[0].values.FieldingScoreAggAvg) {
                FieldingScoreColor = "#0571b0";
            }
            else if (batScore[0].values.FieldingScore >= batScore[0].values.FieldingScoreAggAvg) {
                FieldingScoreColor = "#92c5de";
            }
            else if (batScore[0].values.FieldingScore < batScore[0].values.FieldingScoreAggAvg-batScore[0].values.FieldingScoreAggSd ) {
                FieldingScoreColor = "#ca0020";
            }
            else if (batScore[0].values.FieldingScore <= batScore[0].values.FieldingScoreAggAvg) {
                FieldingScoreColor = "#f4a582";
            }
            return FieldingScoreColor

        }
        // aggregating the bat score data by year
        filteredToYear = cricketdummy.filter(function(d){return d.Year == selectedOption;});
        var batScore = aggregateData()
        console.log(batScore);
        var batScoreColor = getBatScoreColor(batScore)
        var bowlScoreColor = getBowlScoreColor(batScore)

        function drawCricketField() {
            //Position of Field
            var d = document.getElementById('field');
            d.style.position = "absolute";
            d.style.left = 15+'px';
            d.style.top = 45+'px';
            //Field size variables


            var outfieldBase = cricketField.append("ellipse")
                .attr("cx", fieldSVGWidth/centerOfFieldFactor)
                .attr("cy", fieldSVGHeight/centerOfFieldFactor)
                .attr("rx", fieldSVGWidth/2)
                .attr("ry", (fieldSVGHeight/2)/outfieldShapeFactor )
                .attr("fill",  "#008451");


            var outfieldBaseWhiteBorder = cricketField.append("ellipse")
                .attr("cx", fieldSVGWidth/centerOfFieldFactor)
                .attr("cy", fieldSVGHeight/centerOfFieldFactor)
                .attr("rx", fieldSVGWidth/2.06)
                .attr("ry", (fieldSVGHeight/2.06)/outfieldShapeFactor )
                .attr("fill",  "none")
                .attr("stroke", "#f6f9f9")
                .style("stroke-width", fieldWhiteBorderWidths)


            var infieldBase = cricketField.append("ellipse")
                .attr("cx", fieldSVGWidth/centerOfFieldFactor)
                .attr("cy", fieldSVGHeight/centerOfFieldFactor)
                .attr("rx", fieldSVGWidth/3.25)
                .attr("ry", (fieldSVGHeight/3.25)/infieldShapeFactor )
                .attr("fill",  "#00902e");

            var infieldBaseWhiteBorder = cricketField.append("ellipse")
                .attr("cx", fieldSVGWidth/centerOfFieldFactor)
                .attr("cy", fieldSVGHeight/centerOfFieldFactor)
                .attr("rx", fieldSVGWidth/3.25)
                .attr("ry", (fieldSVGHeight/3.25)/infieldShapeFactor )
                .attr("fill",  "none")
                .attr("stroke", "#f6f9f9")
                .style("stroke-width", fieldWhiteBorderWidths)

            var closeinfieldTop = cricketField.append("circle")
                .attr("id","closeinfieldTop")
                .attr("cx", fieldSVGWidth/centerOfFieldFactor)
                .attr("cy", fieldSVGHeight/centerOfFieldFactor - closeInfieldOffset)
                .attr("r", fieldSVGWidth/11)
                .attr("fill",  "none")
                .style("stroke-dasharray", ("10,3"))
                .attr("stroke", "#f6f9f9")
                .style("stroke-width", 2);

            var closeinfieldBottom = cricketField.append("circle")
                .attr("cx", fieldSVGWidth/centerOfFieldFactor)
                .attr("cy", fieldSVGHeight/centerOfFieldFactor + closeInfieldOffset)
                .attr("r", fieldSVGWidth/11)
                .attr("fill",  "none")
                .attr("stroke", "#f6f9f9")
                .style("stroke-dasharray", ("10,3"))
                .style("stroke-width", 2);

            var pitchArea = cricketField.append("rect")
                .attr("x", (fieldSVGWidth/centerOfFieldFactor) - pitchWidth/2)
                .attr("y", (fieldSVGHeight/centerOfFieldFactor) - pitchHeight/2)
                .attr("width", pitchWidth)
                .attr("height", pitchHeight)
                .attr("fill",  "#fff16e")
                .attr("stroke", "#f6f9f9")
                .style("stroke-width", .5);


            var closeInfieldTopLine = cricketField.append("line")
                .attr("x1", (fieldSVGWidth/centerOfFieldFactor - closeInfieldLineLength) )
                .attr("y1", (fieldSVGHeight/centerOfFieldFactor - closeInfieldOffset) )
                .attr("x2", (fieldSVGWidth/centerOfFieldFactor + closeInfieldLineLength) )
                .attr("y2", (fieldSVGHeight/centerOfFieldFactor - closeInfieldOffset) )
                .attr("stroke", "#f6f9f9")
                .style("stroke-width", 1.5);

            var closeInfieldBottomLine = cricketField.append("line")
                .attr("x1", (fieldSVGWidth/centerOfFieldFactor - closeInfieldLineLength) )
                .attr("y1", (fieldSVGHeight/centerOfFieldFactor + closeInfieldOffset) )
                .attr("x2", (fieldSVGWidth/centerOfFieldFactor + closeInfieldLineLength) )
                .attr("y2", (fieldSVGHeight/centerOfFieldFactor + closeInfieldOffset) )
                .attr("stroke", "#f6f9f9")
                .style("stroke-width", 1.5);


            var batScoreAreaLabel = cricketField.append("text")
                .attr("x", fieldSVGWidth/centerOfFieldFactor - 55)
                .attr("y", fieldSVGHeight/centerOfFieldFactor - closeInfieldOffset + 15)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .style("fill", "#f6f9f9")
                .style("font-family", "Helvetica")
                .text("Batting");

            var bowlScoreAreaLabel = cricketField.append("text")
                .attr("x", fieldSVGWidth/centerOfFieldFactor + 55)
                .attr("y", fieldSVGHeight/centerOfFieldFactor + closeInfieldOffset + -6)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .style("fill", "#f6f9f9")
                .style("font-family", "Helvetica")
                .text("Bowling");


            var bowlScoreAreaLabelMeasure = cricketField.append("text")
                .attr("id","bowlScoreAreaLabelMeasure")
                .attr("x", fieldSVGWidth/centerOfFieldFactor)
                .attr("y", fieldSVGHeight/centerOfFieldFactor + closeInfieldOffset + 90)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .style("fill", "#f6f9f9")
                .style("font-family", "Helvetica")
                .text(d3.select("#bowlMeasureFilterSelection").property("value")+": "+(batScore[0].values.BowlScore).toFixed(1));

            var bowlScoreAreaLabelAvg = cricketField.append("text")
                .attr("id","bowlScoreAreaLabelAvg")
                .attr("x", fieldSVGWidth/centerOfFieldFactor)
                .attr("y", fieldSVGHeight/centerOfFieldFactor + closeInfieldOffset + 105)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("fill", "#f6f9f9")
                .style("font-family", "Helvetica")
                .text("League Avg: "+(batScore[0].values.BowlScoreAggAvg).toFixed(1));

            var bowlScoreAreaLabelSd = cricketField.append("text")
                .attr("id","bowlScoreAreaLabelSd")
                .attr("x", fieldSVGWidth/centerOfFieldFactor)
                .attr("y", fieldSVGHeight/centerOfFieldFactor + closeInfieldOffset + 120)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("fill", "#f6f9f9")
                .style("font-family", "Helvetica")
                .text("League Std Dev: "+(batScore[0].values.BowlScoreAggSd).toFixed(1));

            var batScoreAreaLabelMeasure = cricketField.append("text")
                .attr("id","batScoreAreaLabelMeasure")
                .attr("x", fieldSVGWidth/centerOfFieldFactor)
                .attr("y", fieldSVGHeight/centerOfFieldFactor + closeInfieldOffset - 185)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .style("fill", "#f6f9f9")
                .style("font-family", "Helvetica")
                .text(d3.select("#batMeasureFilterSelection").property("value")+": "+(batScore[0].values.BatScore).toFixed(1));

            var batScoreAreaLabelAvg = cricketField.append("text")
                .attr("id","batScoreAreaLabelAvg")
                .attr("x", fieldSVGWidth/centerOfFieldFactor)
                .attr("y", fieldSVGHeight/centerOfFieldFactor + closeInfieldOffset - 170)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("fill", "#f6f9f9")
                .style("font-family", "Helvetica")
                .text("League Avg: "+(batScore[0].values.BatScoreAggAvg).toFixed(1));

            var batScoreAreaLabelSd = cricketField.append("text")
                .attr("id","batScoreAreaLabelSd")
                .attr("x", fieldSVGWidth/centerOfFieldFactor)
                .attr("y", fieldSVGHeight/centerOfFieldFactor + closeInfieldOffset - 155)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("fill", "#f6f9f9")
                .style("font-family", "Helvetica")
                .text("League Std Dev: "+(batScore[0].values.BatScoreAggSd).toFixed(1));


            // half circle variables
            var start = -.5 * Math.PI;
            var size = Math.PI;
            var startbottom = .5 * Math.PI;

            var arcTop = d3.svg.arc()
                .innerRadius(0)
                .outerRadius(75)
                .startAngle(start)
                .endAngle(start + size);

            var chart = cricketField.append("svg")
                .attr("width", 420)
                .attr("height", 420).append("svg:g")
                .attr("transform", "translate(250,264)");

            chart.selectAll("path")
                .data(batScore)
                .enter().append("svg:path")
                .style("opacity", scoreAreaOpacity)
                .style("fill", batScoreColor)
                .attr("id", "arcTop")
                .attr("d", arcTop)
                .attr("stroke", batScoreColor)
                .style("stroke-width", 2);

            var arcBottom = d3.svg.arc()
                .innerRadius(0)
                .outerRadius(75)
                .startAngle(startbottom)
                .endAngle(startbottom + size);

            var chartBottom = cricketField.append("svg")
                .attr("width", 420)
                .attr("height", 420).append("svg:g")
                .attr("transform", "translate(250,336)");

            chartBottom.selectAll("path")
                .data(batScore)
                .enter().append("svg:path")
                .style("opacity", scoreAreaOpacity)
                .style("fill",  bowlScoreColor )
                .attr("stroke", bowlScoreColor)
                .attr("id", "arcBottom")
                .attr("d", arcBottom);


        }

        function updateStats() {
            d3.select("#bowlScoreAreaLabelMeasure").transition().duration(500).text(d3.select("#bowlMeasureFilterSelection").property("value")+": "+(batScore[0].values.BowlScore).toFixed(1));
            d3.select("#bowlScoreAreaLabelAvg").transition().duration(500).text("League Avg: "+(batScore[0].values.BowlScoreAggAvg).toFixed(1));
            d3.select("#bowlScoreAreaLabelSd").transition().duration(500).text("League Std Dev: "+(batScore[0].values.BowlScoreAggSd).toFixed(1));
            d3.select("#batScoreAreaLabelMeasure").transition().duration(500).text(d3.select("#batMeasureFilterSelection").property("value")+": "+(batScore[0].values.BatScore).toFixed(1));
            d3.select("#batScoreAreaLabelAvg").transition().duration(500).text("League Avg: "+(batScore[0].values.BatScoreAggAvg).toFixed(1));
            d3.select("#batScoreAreaLabelSd").transition().duration(500).text("League Std Dev: "+(batScore[0].values.BatScoreAggSd).toFixed(1));

        }


        d3.select("#yearFilterSelection").on("change", function(d) {

            var selectedOption = d3.select(this).property("value");
            filteredToYear = cricketdummy.filter(function(d){return d.Year == selectedOption;});
            var batScore = aggregateData();
            var batScoreColor = getBatScoreColor(batScore);
            var bowlScoreColor = getBowlScoreColor(batScore);
            var FieldingScoreColor = getFieldingScoreColor(batScore);
            d3.select("#arcTop").transition().duration(500).attr("stroke", batScoreColor).style("fill",  batScoreColor );
            d3.select("#arcBottom").transition().duration(500).attr("stroke", bowlScoreColor).style("fill",  bowlScoreColor );
            d3.select("#fieldScoreArea").transition().duration(500).attr("stroke", FieldingScoreColor)

            d3.select("#bowlScoreAreaLabelMeasure").transition().duration(500).text(d3.select("#bowlMeasureFilterSelection").property("value")+": "+(batScore[0].values.BowlScore).toFixed(1));
            d3.select("#bowlScoreAreaLabelAvg").transition().duration(500).text("League Avg: "+(batScore[0].values.BowlScoreAggAvg).toFixed(1));
            d3.select("#bowlScoreAreaLabelSd").transition().duration(500).text("League Std Dev: "+(batScore[0].values.BowlScoreAggSd).toFixed(1));
            d3.select("#batScoreAreaLabelMeasure").transition().duration(500).text(d3.select("#batMeasureFilterSelection").property("value")+": "+(batScore[0].values.BatScore).toFixed(1));
            d3.select("#batScoreAreaLabelAvg").transition().duration(500).text("League Avg: "+(batScore[0].values.BatScoreAggAvg).toFixed(1));
            d3.select("#batScoreAreaLabelSd").transition().duration(500).text("League Std Dev: "+(batScore[0].values.BatScoreAggSd).toFixed(1));
        });
        d3.select("#batMeasureFilterSelection").on("change", function(d) {

            var batScore = aggregateData();
            var batScoreColor = getBatScoreColor(batScore);
            var bowlScoreColor = getBowlScoreColor(batScore);
            var FieldingScoreColor = getFieldingScoreColor(batScore);
            d3.select("#arcTop").attr("stroke", batScoreColor).style("fill",  batScoreColor );
            d3.select("#arcBottom").attr("stroke", bowlScoreColor).style("fill",  bowlScoreColor );
            d3.select("#fieldScoreArea").attr("stroke", FieldingScoreColor)

            d3.select("#bowlScoreAreaLabelMeasure").transition().duration(500).text(d3.select("#bowlMeasureFilterSelection").property("value")+": "+(batScore[0].values.BowlScore).toFixed(1));
            d3.select("#bowlScoreAreaLabelAvg").transition().duration(500).text("League Avg: "+(batScore[0].values.BowlScoreAggAvg).toFixed(1));
            d3.select("#bowlScoreAreaLabelSd").transition().duration(500).text("League Std Dev: "+(batScore[0].values.BowlScoreAggSd).toFixed(1));
            d3.select("#batScoreAreaLabelMeasure").transition().duration(500).text(d3.select("#batMeasureFilterSelection").property("value")+": "+(batScore[0].values.BatScore).toFixed(1));
            d3.select("#batScoreAreaLabelAvg").transition().duration(500).text("League Avg: "+(batScore[0].values.BatScoreAggAvg).toFixed(1));
            d3.select("#batScoreAreaLabelSd").transition().duration(500).text("League Std Dev: "+(batScore[0].values.BatScoreAggSd).toFixed(1));
        });
        d3.select("#scatterMeasureFilterSelection").on("change", function(d) {

            d3.select("#ScatterPlotSVG").remove();
            drawScatterPlot()
        });
        d3.select("#bowlMeasureFilterSelection").on("change", function(d) {

            var batScore = aggregateData();
            var batScoreColor = getBatScoreColor(batScore);
            var bowlScoreColor = getBowlScoreColor(batScore);
            var FieldingScoreColor = getFieldingScoreColor(batScore);
            d3.select("#arcTop").transition().duration(500).attr("stroke", batScoreColor).style("fill",  batScoreColor );
            d3.select("#arcBottom").transition().duration(500).attr("stroke", bowlScoreColor).style("fill",  bowlScoreColor );
            d3.select("#fieldScoreArea").transition().duration(500).attr("stroke", FieldingScoreColor)

            d3.select("#bowlScoreAreaLabelMeasure").transition().duration(500).text(d3.select("#bowlMeasureFilterSelection").property("value")+": "+(batScore[0].values.BowlScore).toFixed(1));
            d3.select("#bowlScoreAreaLabelAvg").transition().duration(500).text("League Avg: "+(batScore[0].values.BowlScoreAggAvg).toFixed(1));
            d3.select("#bowlScoreAreaLabelSd").transition().duration(500).text("League Std Dev: "+(batScore[0].values.BowlScoreAggSd).toFixed(1));
            d3.select("#batScoreAreaLabelMeasure").transition().duration(500).text(d3.select("#batMeasureFilterSelection").property("value")+": "+(batScore[0].values.BatScore).toFixed(1));
            d3.select("#batScoreAreaLabelAvg").transition().duration(500).text("League Avg: "+(batScore[0].values.BatScoreAggAvg).toFixed(1));
            d3.select("#batScoreAreaLabelSd").transition().duration(500).text("League Std Dev: "+(batScore[0].values.BatScoreAggSd).toFixed(1));
        });
        d3.select("#teamFilterSelection").on("change", function(d) {

            var batScore = aggregateData();
            var scatterData = aggregateDataScatter();
            var batScoreColor = getBatScoreColor(batScore);
            var bowlScoreColor = getBowlScoreColor(batScore);
            var FieldingScoreColor = getFieldingScoreColor(batScore);
            d3.select("#arcTop").transition().duration(500).attr("stroke", batScoreColor).style("fill",  batScoreColor )
            d3.select("#arcBottom").transition().duration(500).attr("stroke", bowlScoreColor).style("fill",  bowlScoreColor );
            d3.select("#fieldScoreArea").transition().duration(500).attr("stroke", FieldingScoreColor)

            d3.select("#bowlScoreAreaLabelMeasure").transition().duration(500).text(d3.select("#bowlMeasureFilterSelection").property("value")+": "+(batScore[0].values.BowlScore).toFixed(1));
            d3.select("#bowlScoreAreaLabelAvg").transition().duration(500).text("League Avg: "+(batScore[0].values.BowlScoreAggAvg).toFixed(1));
            d3.select("#bowlScoreAreaLabelSd").transition().duration(500).text("League Std Dev: "+(batScore[0].values.BowlScoreAggSd).toFixed(1));
            d3.select("#batScoreAreaLabelMeasure").transition().duration(500).text(d3.select("#batMeasureFilterSelection").property("value")+": "+(batScore[0].values.BatScore).toFixed(1));
            d3.select("#batScoreAreaLabelAvg").transition().duration(500).text("League Avg: "+(batScore[0].values.BatScoreAggAvg).toFixed(1));
            d3.select("#batScoreAreaLabelSd").transition().duration(500).text("League Std Dev: "+(batScore[0].values.BatScoreAggSd).toFixed(1));
            d3.select("#ScatterPlotSVG").remove();
            drawScatterPlot()

            d3.selectAll("#Sparkline").remove();

            leftSpark("#leftSpark1","BowlingEconomy","bowl")
            leftSpark("#leftSpark2","WicketsPerOver","bowl")
            leftSpark("#leftSpark3","TotalWickets","bowl")
            leftSpark("#leftSpark4","WicketsPerMatch","bowl")
            leftSpark("#middleSpark1","RunsScored","bat")
            leftSpark("#middleSpark2","BallsFaced","bat")
            leftSpark("#middleSpark3","StrikeRate","bat")
            leftSpark("#middleSpark4","NotOuts","bat")
            leftSpark("#rightSpark1","100s","bat")
            leftSpark("#rightSpark2","50s","bat")
            leftSpark("#rightSpark3","4s","bat")
            leftSpark("#rightSpark4","6s","bat")

        });
        drawCricketField();



        function drawScatterPlot() {
            var scatterData = aggregateDataScatter()
            console.log(scatterData)
            var margin = {top: 20, right: 20, bottom: 30, left: 40},
                width = 500 - margin.left - margin.right,
                height = 325 - margin.top - margin.bottom;

// setup x
            var xValue = function(d) { return d.values.MatchesWon;},
                xScale = d3.scale.linear().range([0, width]),
                xMap = function(d) { return xScale(xValue(d));},
                xAxis = d3.svg.axis().scale(xScale).orient("bottom");

// setup y
            var yValue = function(d) { return d.values.ScatterMeasure;},
                yScale = d3.scale.linear().range([height, 0]),
                yMap = function(d) { return yScale(yValue(d));},
                yAxis = d3.svg.axis().scale(yScale).orient("left");

// setup fill color
            var cValue = function(d) { return d.Team;},
                color = d3.scale.category10();

// add the graph canvas to the body of the webpage
            var svg = d3.select("#scatterPlot").append("svg")
                .attr("id","ScatterPlotSVG")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// add the tooltip area to the webpage
            var tooltip = d3.select("#scatterPlot").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            var scatterMeasureLabel = d3.select("#scatterMeasureFilterSelection").property("value")

            xScale.domain([d3.min(scatterData, xValue)-1, d3.max(scatterData, xValue)+1]);
            yScale.domain([d3.min(scatterData, yValue)-1, d3.max(scatterData, yValue)+1]);

            // x-axis
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis)
                .append("text")
                .attr("class", "label")
                .attr("x", width)
                .attr("y", -6)
                .style("text-anchor", "end")
                .text("Matches Won");

            // y-axis
            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append("text")
                .attr("class", "label")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text(scatterMeasureLabel);

            // draw dots
            svg.selectAll(".dot")
                .data(scatterData)
                .enter().append("circle")
                .attr("id","scatterUpdate")
                .attr("class", "dot")
                .attr("r", 7.5)
                .attr("cx", xMap)
                .attr("cy", yMap)
                .style("fill", function (d) {
                    if (d.values.ScatterMeasure > d.values.ScatterMeasureAggSd + d.values.ScatterMeasureAggAvg) {
                        return  "#0571b0";
                    }
                    else if (d.values.ScatterMeasure >= d.values.ScatterMeasureAggAvg) {
                        return "#92c5de";
                    }
                    else if (d.values.ScatterMeasure < d.values.ScatterMeasureAggAvg-d.values.ScatterMeasureAggSd ) {
                        return "#ca0020";
                    }
                    else if (d.values.ScatterMeasure <= d.values.ScatterMeasureAggAvg) {
                        return "#f4a582";
                    }
                })
                .on("mouseover", function(d) {
                    d3.select(this)
                        .transition()
                        .duration(500)
                        .attr('r',20)
                        .attr('stroke-width',3);

                    d3.select('#yearFilterSelection').property('value', d.key);
                    var yearSelection = d.key
                    console.log(yearSelection)

                    d3.csv("cricketPivot.csv", function(cricketdummy){

                        filteredToYear  = cricketdummy.filter(function(d){return d.Year == yearSelection;});
                        var batScore = aggregateData();
                        var batScoreColor = getBatScoreColor(batScore);
                        var bowlScoreColor = getBowlScoreColor(batScore);
                        var FieldingScoreColor = getFieldingScoreColor(batScore);
                        d3.select("#arcTop").transition().duration(500).attr("stroke", batScoreColor).style("fill",  batScoreColor );
                        d3.select("#arcBottom").transition().duration(500).attr("stroke", bowlScoreColor).style("fill",  bowlScoreColor );
                        d3.select("#fieldScoreArea").transition().duration(500).attr("stroke", FieldingScoreColor)

                        d3.select("#bowlScoreAreaLabelMeasure").transition().duration(500).text(d3.select("#bowlMeasureFilterSelection").property("value")+": "+(batScore[0].values.BowlScore).toFixed(1));
                        d3.select("#bowlScoreAreaLabelAvg").transition().duration(500).text("League Avg: "+(batScore[0].values.BowlScoreAggAvg).toFixed(1));
                        d3.select("#bowlScoreAreaLabelSd").transition().duration(500).text("League Std Dev: "+(batScore[0].values.BowlScoreAggSd).toFixed(1));
                        d3.select("#batScoreAreaLabelMeasure").transition().duration(500).text(d3.select("#batMeasureFilterSelection").property("value")+": "+(batScore[0].values.BatScore).toFixed(1));
                        d3.select("#batScoreAreaLabelAvg").transition().duration(500).text("League Avg: "+(batScore[0].values.BatScoreAggAvg).toFixed(1));
                        d3.select("#batScoreAreaLabelSd").transition().duration(500).text("League Std Dev: "+(batScore[0].values.BatScoreAggSd).toFixed(1));
                    })

                })
                .on("mouseout", function(d) {
                    d3.select(this)
                        .transition()
                        .duration(500)
                        .attr('r',7.5)
                        .attr('stroke-width',1)
                })
                .append('title') // Tooltip
                .text(function (d) { return d.key +
                    '\nMatches Won: ' + d.values.MatchesWon +
                    '\n'+ scatterMeasureLabel +': ' + d.values.ScatterMeasure
                    })


        }
        drawScatterPlot()
        drawMapLegend()

        function leftSpark(divElement,sparkMeasure,measureType) {

            filteredToMeasure = cricketdummy.filter(function(d){return d.MeasureName == sparkMeasure;});
            var dataAggregation = d3.nest()
                .key(function(d) { return d.Year;})
                .rollup(function(d) { return {
                    BatScoreAggAvg: d3.mean(d, function(d) { return d.MeasureValue}),
                    BatScoreAggSd: d3.deviation(d, function(d) { return d.MeasureValue}),
                    BatScore: d3.sum(d, function(d) { if (d.Team  == d3.select("#teamFilterSelection").property("value") ) { return d.MeasureValue }
                    else { return 0 }
                        ; })
                }; }).entries(filteredToMeasure);

            var margin = {top: 20, right: 5, bottom: 70, left: 5},
                width = 125,
                height = 50 ;

            filteredToMeasure.forEach(function (d) {
                d.Year = d.Year;
                d.MeasureValue = +d.MeasureValue;
            });

            var x = d3.scale.ordinal().rangeRoundBands([0, width], .05);

            var y = d3.scale.linear().range([height, 0]);
            var xAxis = d3.svg.axis()
                .scale(x)
                .orient("bottom")
            var yAxis = d3.svg.axis()
                .scale(y)
                .orient("left")
                .ticks(10);

            var svg = d3.select(divElement).append("svg")
                .attr("id","Sparkline")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");


            x.domain(dataAggregation.map(function (d) {
                return d.key;
            }));
            y.domain([0, d3.max(dataAggregation, function (d) {
                return d.values.BatScore;
            })]);

            svg.selectAll("bar")
                .data(dataAggregation)
                .enter().append("rect")
                 .style("fill", function (d) {
                     if (d.values.BatScore > d.values.BatScoreAggSd + d.values.BatScoreAggAvg) {
                         return  "#0571b0";
                     }
                     else if (d.values.BatScore >= d.values.BatScoreAggAvg) {
                         return "#92c5de";
                     }
                     else if (d.values.BatScore < d.values.BatScoreAggAvg-d.values.BatScoreAggSd ) {
                         return "#ca0020";
                     }
                     else if (d.values.BatScore <= d.values.BatScoreAggAvg) {
                         return "#f4a582";
                     }
                 })
                .attr("x", function (d) {
                    return x(d.key);
                })
                .attr("width", x.rangeBand() * .9)
                .attr("y", function (d) {
                    return y(d.values.BatScore);
                })
                .attr("height", function (d) {
                    return height - y(d.values.BatScore);
                })
                .on("mouseover", function(d) {
                    d3.select(this)
                        .transition()
                        .duration(250)
                        .style("fill","orange")

                    d3.select('#yearFilterSelection').property('value', d.key);
                    var yearSelection = d.key
                    console.log(yearSelection)

                    if (measureType == "bat") {d3.select('#batMeasureFilterSelection').property('value', sparkMeasure);}
                    if (measureType == "bowl") {d3.select('#bowlMeasureFilterSelection').property('value', sparkMeasure);}
                    d3.csv("cricketPivot.csv", function(cricketdummy){

                        filteredToYear  = cricketdummy.filter(function(d){return d.Year == yearSelection;});
                        var batScore = aggregateData();
                        var batScoreColor = getBatScoreColor(batScore);
                        var bowlScoreColor = getBowlScoreColor(batScore);
                        var FieldingScoreColor = getFieldingScoreColor(batScore);
                        d3.select("#arcTop").transition().duration(500).attr("stroke", batScoreColor).style("fill",  batScoreColor );
                        d3.select("#arcBottom").transition().duration(500).attr("stroke", bowlScoreColor).style("fill",  bowlScoreColor );
                        d3.select("#fieldScoreArea").transition().duration(500).attr("stroke", FieldingScoreColor)

                        d3.select("#bowlScoreAreaLabelMeasure").transition().duration(500).text(d3.select("#bowlMeasureFilterSelection").property("value")+": "+(batScore[0].values.BowlScore).toFixed(1));
                        d3.select("#bowlScoreAreaLabelAvg").transition().duration(500).text("League Avg: "+(batScore[0].values.BowlScoreAggAvg).toFixed(1));
                        d3.select("#bowlScoreAreaLabelSd").transition().duration(500).text("League Std Dev: "+(batScore[0].values.BowlScoreAggSd).toFixed(1));
                        d3.select("#batScoreAreaLabelMeasure").transition().duration(500).text(d3.select("#batMeasureFilterSelection").property("value")+": "+(batScore[0].values.BatScore).toFixed(1));
                        d3.select("#batScoreAreaLabelAvg").transition().duration(500).text("League Avg: "+(batScore[0].values.BatScoreAggAvg).toFixed(1));
                        d3.select("#batScoreAreaLabelSd").transition().duration(500).text("League Std Dev: "+(batScore[0].values.BatScoreAggSd).toFixed(1));

                    })
                })
                .on("mouseout", function(d) {
                    d3.select(this)
                        .transition()
                        .duration(500)
                        .style("fill", function (d) {
                            if (d.values.BatScore > d.values.BatScoreAggSd + d.values.BatScoreAggAvg) {
                                return  "#0571b0";
                            }
                            else if (d.values.BatScore >= d.values.BatScoreAggAvg) {
                                return "#92c5de";
                            }
                            else if (d.values.BatScore < d.values.BatScoreAggAvg-d.values.BatScoreAggSd) {
                                return "#ca0020";
                            }
                            else if (d.values.BatScore <= d.values.BatScoreAggAvg) {
                                return "#f4a582";
                            }
                        })
                })

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(0)")
                .attr("y", 6)
                .attr("dy", "-.55em")
                .style("text-anchor", "start")
                .style("font-size", "12")
                .text(sparkMeasure);
        }
        leftSpark("#leftSpark1","BowlingEconomy","bowl")
        leftSpark("#leftSpark2","WicketsPerOver","bowl")
        leftSpark("#leftSpark3","TotalWickets","bowl")
        leftSpark("#leftSpark4","WicketsPerMatch","bowl")
        leftSpark("#middleSpark1","RunsScored","bat")
        leftSpark("#middleSpark2","BallsFaced","bat")
        leftSpark("#middleSpark3","StrikeRate","bat")
        leftSpark("#middleSpark4","NotOuts","bat")
        leftSpark("#rightSpark1","100s","bat")
        leftSpark("#rightSpark2","50s","bat")
        leftSpark("#rightSpark3","4s","bat")
        leftSpark("#rightSpark4","6s","bat")



    });







</script>
</body>
</html>